---
#
#     Copyright 2018,2017 Red Hat, Inc
#
#     Licensed under the Apache License, Version 2.0 (the "License");
#     you may not use this file except in compliance with the License.
#     You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.
#

- name: check for katello-cert
  yum:
    list:   "katello-ca-consumer-{{ satellite_fqdn }}.noarch"
  register: katello_cert

- set_fact:
    katello_cert: "{{ katello_cert.results[0].name.split() | length }}"
  when: ( katello_cert.results | length > 0 )

- name: "check for {{ satellite_fqdn }} in /etc/rhsm/rhsm.conf"
  slurp:
    src: /etc/rhsm/rhsm.conf
  register: rhsm

- shell:         "/usr/bin/grep -riL 'baseurl'"
  args:
    chdir:       "/etc/yum.repos.d/"
  ignore_errors: true
  register:      files

- set_fact:
    rhsm_fqdn:    "hostname = {{ satellite_fqdn }}"

- set_fact:
    rhsm:         "{{ rhsm.content | b64decode | regex_findall(rhsm_fqdn) | length }}"
    katello_cert: "{{ katello_cert.results | selectattr('name','defined') | selectattr('name','match', kat_cert) | list | length }}"
    files:        "{{ files.stdout_lines }}"
    files_test:   "{{ files.stdout_lines | default([]) | length }}"
